stages:
  - build
  - test
  - deploy

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

build_site:
  stage: build
  image: python:3.9-slim
  script:
    - echo "--- [Pattern 1] Start: Running code in Python container ---"
    - echo "Step 1.1: Installing dependencies (mkdocs)..."
    - pip install mkdocs
    - echo "Step 1.2: Executing core build command (mkdocs build)..."
    - mkdocs build --strict
    - echo "Step 1.3: Checking results..."
    - ls -l
    - echo "--- [Pattern 1] Proof: 'site' directory created. Build successful. ---"
  artifacts:
    paths:
      - site/

test_site:
  stage: test
  image: alpine:latest
  dependencies:
    - build_site
  script:
    - echo "--- [Pattern 2] Start: Running regression tests in Alpine container ---"
    - echo "Step 2.1: Checking if 'site' directory exists..."
    - ls -l
    - echo "Step 2.2: Executing regression test (checking if index.html exists)..."
    - test -f site/index.html
    - echo "--- [Pattern 2] Proof: 'site/index.html' exists. Regression test passed. ---"

pages:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build_site
  script:
    - echo "--- [Pattern 3] Start: Deploying service ---"
    - echo "Step 3.1: Renaming 'site' directory to 'public' (GitLab Pages requirement)"
    - mv site public
    - echo "Step 3.2: Checking 'public' directory..."
    - ls -l
    - echo "--- [Pattern 3] Proof: 'public' directory ready. GitLab Pages will host it automatically. ---"
  artifacts:
    paths:
      - public/